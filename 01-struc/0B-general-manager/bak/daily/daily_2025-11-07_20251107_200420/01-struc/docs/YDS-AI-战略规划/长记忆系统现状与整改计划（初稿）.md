长记忆（LongMemory）系统现状与整改计划（初稿）

更新时间：2025-11-04
负责人：技术负责人（Trae助理）

一、背景与目标
- 背景：用户希望确认长记忆系统是否在后台工作，以及是否自动记录之前的交互内容；当前目录结构需要优化，暂缓立即改动运行逻辑，但需将问题与现状完整留档。
- 目标：形成一份技术记录，明确系统现状、证据与影响、整改方案与待办清单，供后续“目录结构清理优化”完成后执行与验证。

二、结论与现状概述
- 非自启动：长记忆模块（LongMemory）默认不会随服务自动启动，需要通过 REST 接口显式启动（/mcp/lm/start）。
- 审计日志已自动留存：系统层面的交互事件（文档分享、投票、语音调用、LM启动尝试等）均以 JSONL 形式写入审计日志：01-struc/0B-general-manager/logs/audit_trails/meetingroom_docs_share.jsonl。
- LM持久化路径已统一：LongMemory 子系统的持久化文件统一为 01-struc/0B-general-manager/logs/longmemory/lm_records.json，并与 Trae IDE 的 Memory MCP 使用的 memory.json 完全解耦。此前“docs/02-开发/memory.json”的旧路径已废弃。

三、关键证据与引用
- 路由与启动要求（文件：03-dev/JS001-meetingroom/servers/meetingroom_server.py）
  1) /mcp/lm/start（POST）：启动组件，payload 需包含 { role, component: reminder|monitor }
  2) /mcp/lm/status（GET）：查询组件运行状态，需传 role 并通过 RBAC
  3) /mcp/lm/stop（POST）：停止组件
  4) _lm_status：未启动时返回 { reminder: {monitoring_status: "stopped"}, monitor: {monitoring_active: false} }
- LM模块的持久化文件路径（文件：tools/LongMemory/*）
1) proactive_reminder.py：self.memory_path = "01-struc/0B-general-manager/logs/longmemory/lm_records.json"
2) intelligent_monitor.py：self.memory_path = "01-struc/0B-general-manager/logs/longmemory/lm_records.json"
3) smart_error_detector.py：self.memory_path = "01-struc/0B-general-manager/logs/longmemory/lm_records.json"
- 审计日志样例（文件：01-struc/0B-general-manager/logs/audit_trails/meetingroom_docs_share.jsonl）
  - 包含事件：docs_share/docs_revoke、vote_create/vote_cast/vote_finalize、voice_stream、lm_start、lm_start_failed …
  - 失败原因示例：monitor 在非主线程环境下设置信号报错（代码已兼容处理，不影响手工启动与运行），以及路径未定义导致启动失败等。

四、风险与影响评估
- 运行层面：lm_records.json 为统一持久化文件。如该文件或目录不存在，首次运行会初始化为 {"general": {}, "memories": []}，否则提醒/干预记录将无法落地。
- 数据一致性：系统审计日志与 LM 记忆文件路径与格式不同（审计=JSONL，记忆=JSON）。需通过文档明确数据治理规范与备份策略。
- 配置可维护性：memory_path 已通过 yds_ai_config.yaml 和服务层注入支持配置覆盖，避免硬编码路径。

五、建议整改方案（已统一路径，目录结构优化持续推进）
1) 建立与校验持久化目录与初始文件
   - 创建目录：S:\YDS-Lab\01-struc\Log\longmemory
   - 初始化文件：S:\YDS-Lab\01-struc\Log\longmemory\lm_records.json（初始内容：{"general": {}, "memories": []}）。若由服务自动创建，则人工仅需校验。
2) 启动与验证（在服务器正常运行的前提下）
   - 启动提醒子系统：POST /mcp/lm/start，body: {"role":"developer","component":"reminder"}
   - 启动监控子系统：POST /mcp/lm/start，body: {"role":"developer","component":"monitor"}
   - 状态查询：GET /mcp/lm/status?role=developer
   - 验证写入：检查 lm_records.json 是否新增 proactive_reminder / smart_error_alert / intelligent_intervention 记录块
3) 配置化与治理
   - 在 config/yds_ai_config.yaml 中使用 longmemory.storage_path 指定持久化文件，并在服务启动时加载。
   - 文档明确：审计日志与长记忆的差异、留档职责与清理周期；避免与 Trae IDE Memory MCP 的 memory.json 混淆。

六、接口与调用示例
- 启动提醒子系统
  - 方法：POST /mcp/lm/start
  - 请求体：{"role":"developer","component":"reminder"}
  - 正常返回：{"ok":true,"meta":{"component":"reminder","status":"running"},"status":{...}}
- 启动监控子系统
  - 方法：POST /mcp/lm/start
  - 请求体：{"role":"developer","component":"monitor"}
- 查询状态
  - 方法：GET /mcp/lm/status?role=developer
  - 正常返回：{"ok":true,"status":{"reminder":{...},"monitor":{...}},"lm_dir":"..."}
- 停止组件
  - 方法：POST /mcp/lm/stop
  - 请求体：{"role":"developer","component":"reminder"} 或 {"role":"developer","component":"monitor"}

七、后续待办清单（供目录优化完成后执行）
- 目录准备：创建/校验 S:\YDS-Lab\01-struc\Log\longmemory 并初始化 lm_records.json
- 配置增强：支持 LONGMEMORY_PATH 环境变量或 yds_ai_config.yaml 的 longmemory.storage_path
- 启动与验收：执行 /mcp/lm/start 两子系统；用 /mcp/lm/status 验证；检查 lm_records.json 写入
- 文档更新：补充长记忆组件运行与留档流程、与审计日志的差异及治理策略；统一术语与路径
- 自动化脚本：提供一键启动/停止/状态查询的 PowerShell 辅助脚本（可选）

八、备注
- 审计日志当前路径：01-struc/0B-general-manager/logs/audit_trails/meetingroom_docs_share.jsonl（已记录历史交互与LM启动尝试）
- WebSocket 与 JWT 握手策略在此前已具备开关（WS_JWT_REQUIRED），与长记忆逻辑相互独立，可并行推进。