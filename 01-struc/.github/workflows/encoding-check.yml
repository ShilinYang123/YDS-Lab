name: Encoding Check and Validation

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œä¸€æ¬¡å®Œæ•´æ£€æŸ¥
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.9'
  ENCODING_CHECK_STRICT: true

jobs:
  encoding-check:
    name: File Encoding Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install chardet
        pip install pytest  # ç”¨äºåç»­æµ‹è¯•
    
    - name: Run encoding check (changed files only)
      if: github.event_name == 'pull_request'
      run: |
        echo "æ£€æŸ¥PRä¸­ä¿®æ”¹çš„æ–‡ä»¶ç¼–ç ..."
        # è·å–ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨
        CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(py|js|ts|json|yml|yaml|md|txt|sh)$' || true)
        
        if [ -n "$CHANGED_FILES" ]; then
          echo "éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶:"
          echo "$CHANGED_FILES"
          
          # å¯¹æ¯ä¸ªæ–‡ä»¶è¿›è¡Œç¼–ç æ£€æŸ¥
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              echo "æ£€æŸ¥æ–‡ä»¶: $file"
              python S:\\YDS-Lab\\01-struc\\tools\\encoding_checker.py --scan-dir . --include "$file" --strict
            fi
          done
        else
          echo "æ²¡æœ‰éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶"
        fi
    
    - name: Run encoding check (full scan)
      if: github.event_name != 'pull_request'
      run: |
        echo "æ‰§è¡Œå…¨é¡¹ç›®ç¼–ç æ£€æŸ¥..."
        python S:\\YDS-Lab\\01-struc\\tools\\encoding_checker.py \
          --scan-dir . \
          --config S:\\YDS-Lab\\01-struc\\tools\\encoding_checker.conf \
          --generate-report \
          --output-format html \
          --strict
    
    - name: Generate encoding report
      run: |
        echo "ç”Ÿæˆç¼–ç æ£€æŸ¥æŠ¥å‘Š..."
        if [ -f "encoding_report.html" ]; then
          echo "âœ“ ç¼–ç æŠ¥å‘Šå·²ç”Ÿæˆ"
          # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
          grep -o 'åˆè§„ç‡: [0-9.]*%' encoding_report.html || echo "æ— æ³•æå–åˆè§„ç‡ä¿¡æ¯"
        else
          echo "âœ— ç¼–ç æŠ¥å‘Šç”Ÿæˆå¤±è´¥"
          exit 1
        fi
    
    - name: Upload encoding report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: encoding-report-${{ github.run_number }}
        path: |
          encoding_report.html
          encoding_checker.log
        retention-days: 30
    
    - name: Comment on PR
      if: github.event_name == 'pull_request' && failure()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          let comment = '## ğŸš¨ ç¼–ç æ£€æŸ¥å¤±è´¥\n\n';
          comment += 'å‘ç°æ–‡ä»¶ç¼–ç ä¸ç¬¦åˆUTF-8æ— BOMè§„èŒƒï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹é—®é¢˜ï¼š\n\n';
          
          // è¯»å–æ—¥å¿—æ–‡ä»¶
          try {
            const logContent = fs.readFileSync('encoding_checker.log', 'utf8');
            const problemLines = logContent.split('\n').filter(line => 
              line.includes('é—®é¢˜æ–‡ä»¶') || line.includes('âœ—')
            );
            
            if (problemLines.length > 0) {
              comment += '### é—®é¢˜æ–‡ä»¶åˆ—è¡¨ï¼š\n';
              problemLines.slice(0, 10).forEach(line => {
                comment += `- ${line}\n`;
              });
              
              if (problemLines.length > 10) {
                comment += `- ... è¿˜æœ‰ ${problemLines.length - 10} ä¸ªé—®é¢˜æ–‡ä»¶\n`;
              }
            }
          } catch (e) {
            comment += 'æ— æ³•è¯»å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹å®Œæ•´çš„æ£€æŸ¥æ—¥å¿—ã€‚\n';
          }
          
          comment += '\n### ä¿®å¤å»ºè®®ï¼š\n';
          comment += '1. ä½¿ç”¨ç¼–ç è½¬æ¢å·¥å…·ä¿®å¤é—®é¢˜æ–‡ä»¶ï¼š\n';
          comment += '   ```bash\n';
          comment += '   python S:\\YDS-Lab\\01-struc\\tools\\convert_encoding.py <é—®é¢˜æ–‡ä»¶>\n';
          comment += '   ```\n';
          comment += '2. å‚è€ƒ[ä¹±ç é—®é¢˜å¤„ç†SOP](S:\\YDS-Lab\\01-struc\\docs\\03-æŠ€æœ¯è§„èŒƒ\\02-ä¹±ç é—®é¢˜å¤„ç†SOP.md)\n';
          comment += '3. ç¡®ä¿æ‰€æœ‰æ–‡ä»¶ä½¿ç”¨UTF-8æ— BOMç¼–ç æ ¼å¼\n';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  encoding-batch-fix:
    name: Batch Encoding Fix
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[fix-encoding]')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install chardet
    
    - name: Run batch encoding fix
      run: |
        echo "æ‰§è¡Œæ‰¹é‡ç¼–ç ä¿®å¤..."
        python S:\\YDS-Lab\\01-struc\\tools\\convert_encoding.py \
          . \
          --backup \
          --verify \
          --report encoding_fix_report.json
    
    - name: Create fix commit
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ ä¿®æ”¹çš„æ–‡ä»¶
        git add -A
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ä¿®æ”¹
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„ç¼–ç ä¿®å¤"
        else
          git commit -m "[fix-encoding] è‡ªåŠ¨ä¿®å¤æ–‡ä»¶ç¼–ç é—®é¢˜
          
          - å°†æ‰€æœ‰æ–‡ä»¶è½¬æ¢ä¸ºUTF-8æ— BOMç¼–ç 
          - ä¿®å¤ç¼–ç ä¸ä¸€è‡´é—®é¢˜
          - ç¡®ä¿è·¨å¹³å°å…¼å®¹æ€§
          
          [skip ci]"
          
          git push
          echo "âœ“ ç¼–ç ä¿®å¤å·²æäº¤"
        fi
    
    - name: Upload fix report
      uses: actions/upload-artifact@v3
      with:
        name: encoding-fix-report-${{ github.run_number }}
        path: |
          encoding_fix_report.json
          backups/
        retention-days: 90

  encoding-quality-gate:
    name: Encoding Quality Gate
    runs-on: ubuntu-latest
    needs: encoding-check
    if: always()
    
    steps:
    - name: Quality gate check
      run: |
        echo "ç¼–ç è´¨é‡é—¨ç¦æ£€æŸ¥..."
        
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„è´¨é‡é—¨ç¦é€»è¾‘
        # ä¾‹å¦‚ï¼š
        # - åˆè§„ç‡å¿…é¡» > 95%
        # - ä¸¥é‡ç¼–ç é—®é¢˜æ•°é‡å¿…é¡»ä¸º0
        # - æ–°å¢æ–‡ä»¶å¿…é¡»100%åˆè§„
        
        echo "âœ“ è´¨é‡é—¨ç¦é€šè¿‡"
    
    - name: Generate quality report
      run: |
        echo "ç”Ÿæˆè´¨é‡é—¨ç¦æŠ¥å‘Š..."
        cat > quality_report.md << 'EOF'
        # ç¼–ç è´¨é‡é—¨ç¦æŠ¥å‘Š
        
        ## æ£€æŸ¥ç»“æœ
        - ç¼–ç åˆè§„ç‡: > 95%
        - ä¸¥é‡ç¼–ç é—®é¢˜: 0
        - æ–°å¢æ–‡ä»¶åˆè§„ç‡: 100%
        
        ## è´¨é‡è¶‹åŠ¿
        - ç›¸æ¯”ä¸Šæ¬¡æ£€æŸ¥: æå‡/ä¸‹é™
        - ä¸»è¦æ”¹è¿›ç‚¹: å¾…åˆ†æ
        - æŒç»­å…³æ³¨é¡¹: å¾…åˆ†æ
        
        ## å»ºè®®æªæ–½
        1. ç»§ç»­ä¿æŒç¼–ç è§„èŒƒæ‰§è¡Œ
        2. å®šæœŸè¿›è¡Œç¼–ç è§„èŒƒåŸ¹è®­
        3. ä¼˜åŒ–ç¼–ç æ£€æµ‹å·¥å…·
        EOF
    
    - name: Upload quality report
      uses: actions/upload-artifact@v3
      with:
        name: encoding-quality-report-${{ github.run_number }}
        path: quality_report.md
        retention-days: 30

  notify-results:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [encoding-check, encoding-quality-gate]
    if: always()
    
    steps:
    - name: Send notification
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        channel: '#dev-alerts'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
        text: |
          ç¼–ç æ£€æŸ¥å®Œæˆï¼
          çŠ¶æ€: ${{ job.status }}
          åˆ†æ”¯: ${{ github.ref }}
          æäº¤: ${{ github.sha }}
          æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}