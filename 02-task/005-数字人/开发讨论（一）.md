# 开发讨论（一）——数字员工项目全程纪要

> 时间：2025-11-15 下午  
> 参与：一丁山先生（需求方）、雨俊（技术负责人）  
> 目标：按任务书完成端到端数字员工系统开发，直至最终交付

---

## ① 立项与需求澄清（W1-001 ✅）
- **场景与产量**
  - 离线批量：50 条/日，峰值 100 条（≤60 s/条），用于宣传、培训、客服。
  - 准实时演示：端到端延迟 <1 s，支持现场展示。
- **TTS 选型**
  - 中文优先：CosyVoice（字节开源，情感丰富）。
  - 输出：16 kHz/22.05 kHz 单声道 WAV，响度 -23 LUFS。
- **LatentSync 使用方式**
  - 原生 Python 推理为主，ComfyUI 插件作为非技术人员离线备选。
  - 分辨率 1024×1024，采样步数 20，TREPA 权重 0.8。
- **质量指标初定**
  - 唇形一致性：LSE-C ≥0.85、LSE-D ≤2.5（优于 Wav2Lip 基线）。
  - 主观 MOS ≥4.0（5 分制）。
  - 离线失败率 <2 %，演示延迟 <1 s。

## ② 技术路线与关键决策
- **生产环境**：Linux + CUDA 12 + PyTorch 2.1，GPU ≥24 GB（A5000/RTX 4090）。
- **Windows 本机**（Asus GL552VW）：仅运营/演示，核心推理统一转发 Linux 容器。
- **任务队列**：Redis（轻量、高吞吐），状态机：待处理/运行中/成功/失败/取消。
- **存储**：MinIO（本地 S3 兼容）或阿里云 OSS；数据库 PostgreSQL。
- **容器化**：Docker + docker-compose 起步，后续可迁 Kubernetes。

## ③ 当前项目进度梳理（截至 2025-11-15 18:00）
| 模块 | 状态 | 说明 |
|---|---|---|
| 立项与需求 | ✅ | 场景、产量、TTS 选型、指标已固化 |
| 项目目录 & Git | ✅ | 已创建并托管 |
| Docker-Compose 基础服务 | ✅ | Redis、MinIO、PostgreSQL 一键启动脚本就绪 |
| LatentSync 环境 | ⚠️ | 源码+预训练模型已拉取，CPU 模式可跑 512×512，GPU 待迁移 |
| CosyVoice 环境 | ⚠️ | 镜像已拉取，CPU 推理链路打通，GPU 优化待补 |
| 后端 API（FastAPI） | 🚧 | 任务创建/状态/下载 已编码，单元测试 70 % |
| 任务队列（Redis） | 🚧 | 状态机、重试、超时 已实现，待压测 |
| 前端运营门户 | 🚧 | React+Vite 骨架完成，素材上传、任务列表、预览 待联调 |
| 素材规范文档 | ✅ | 参考视频/音频标准、模板库、拍摄指引 已输出 |
| 质量评估脚本 | ⚠️ | LSE-C/LSE-D、MOS、延迟、FPS 采集脚本已编，待集成 CI |
| 安全合规 | ⚠️ | 版权核查清单、访问控制、审计日志 已列计划，待落地 |
| 容器化 & CI/CD | ⚠️ | Dockerfile、github-actions 模板化，待补全 GPU 镜像 |
| 文档 | 🚧 | API 文档（Swagger）、运维手册、用户手册 50 % |

## ④ 剩余功能开发排期（倒排 3 周）
| 周次 | 关键交付 | 责任人 | 完成标准 |
|---|---|---|---|
| W1 剩余 3 天 | GPU 镜像构建 & 512→1024 验证 | 雨俊 | 1024×1024 视频生成成功率 ≥95 %，单条 ≤3 min |
| W2 前 2 天 | 前端联调 & 素材管理闭环 | 前端 | 上传→创建→预览→下载 全流程无阻塞 |
| W2 后 3 天 | 任务队列压测 & 失败重试策略 | 后端 | 并发 20 任务，失败率 <2 %，重试 ≤3 次 |
| W3 前 2 天 | 质量评估自动化 & 报告生成 | 算法 | 一键生成评测报告（含图表），MOS≥4.0 |
| W3 后 3 天 | 安全加固 & 渗透测试 | 运维 | 高危漏洞=0，中危≤2，审计日志完整 |
| 并行 | 文档补齐 & 用户培训视频 | 全组 | 文档覆盖率≥90 %，培训视频≤15 min |

## ⑤ 关键路径技术难点 & 决策记录
1. **GPU 显存不足（24 GB）** → 采用“分段推理+帧缓存”策略，牺牲 10 % 速度换稳定。
2. **Windows 本机 GTX 960M** → 仅演示，所有核心推理转发 Linux 容器，API 超时 30 s。
3. **大文件上传（>500 MB）** → MinIO 预签名 URL，分片 50 MB，并发 3。
4. **质量评估** → 引入“唇形-音频对齐”可视化，方便运营快速定位问题帧。

## ⑥ 接口对接极简版
| 模块 | 接口 | 说明 |
|---|---|---|
| 前端→后端 | POST /api/tasks | FormData 含 text+refVideo，返回 taskId |
| 后端→TTS | POST /internal/tts | 文本→WAV，缓存 24 h |
| 后端→LipSync | POST /internal/lipsync | WAV+参考视频→MP4，回调状态 |
| 后端→MinIO | PUT /{bucket}/{taskId}.mp4 | 成品视频，TTL 30 天 |
| 后端→Redis | LPUSH / BRPOP | 任务队列，JSON 序列化 |

## ⑦ 今日立即行动（YOLO 模式）
- **18:30** 构建 GPU 镜像 & 1024×1024 验证（雨俊）
- **明日 10:00** 前端上传联调 & 队列压测脚本（前后端并行）
- **后日 15:00** 质量评估脚本集成 CI & 安全扫描（算法+运维）
- **每日 18:00** Wiki 更新，直至交付

## ⑧ 风险与应对速览
- **GPU 资源不足** → 夜间批处理 + 分级产能
- **Windows 兼容性** → 生产统一 Linux，Windows 仅运营/演示
- **音频质量波动** → 统一响度与降噪预处理
- **光照/遮挡** → 素材规范 + 审核 + 拍摄指引
- **法务风险** → 上线前完成版权与授权核查，建立审计留痕

---

**下一步指令**：继续 YOLO 全速编码，直至最终交付。任何需求变更请直接回复，我将实时更新本纪要。